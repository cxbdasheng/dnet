<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>D-NET</title>
    <link rel="stylesheet" href="/static/css/layui.css">
    <link rel="stylesheet" href="/static/css/common.css">
    <script src="/static/layui.js"></script>
    <style>
    </style>
</head>
<body>
<div class="layui-layout layui-layout-admin" id="body">
    <div class="layui-header header">
        <div class="layui-container">
            <div class="layui-logo layui-hide-xs layui-bg-black">
                <a href="javascript:;">
                    D-NET
                </a>
            </div>
            <!-- 移动端显示 -->
            <ul class="layui-nav">
                <li class="layui-nav-item layui-show-xs-inline-block layui-hide-sm" lay-header-event="menuLeft">
                    <i class="layui-icon layui-icon-spread-left"></i>
                </li>
            </ul>
            <!-- 头部区域（可配合layui 已有的水平导航） -->
            <div class="ws-header-menu">
                <ul class="layui-nav layui-layout-left" lay-filter="nav-filter">
                    <li class="layui-nav-item layui-hide-xs layui-this"><a href="javascript:;">DCDN</a></li>
                    <li class="layui-nav-item layui-hide-xs"><a href="javascript:;">DDNS</a></li>
                </ul>
            </div>
            <ul class="layui-nav  layui-layout-right" lay-bar="disabled">
                <li class="layui-nav-item" lay-unselect>
                    <a href="javascript:;" id="logs">
                        <button type="button" class="layui-btn">日志</button>
                    </a>
                </li>
                <li class="layui-nav-item" lay-unselect>
                    <a href="javascript:;">
                        <img src="/static/default.jpg" class="layui-nav-img">
                    </a>
                    <dl class="layui-nav-child">
                        <dd><a href="javascript:;" id="webhook-config">Webhook</a></dd>
                        <dd><a href="javascript:;" id="settings">系统设置</a></dd>
                        <hr>
                        <dd style="text-align: center;"><a href="./logout">退出</a></dd>
                    </dl>
                </li>
            </ul>
        </div>
    </div>
    <div class="layui-body" style="overflow: hidden;">
        <!-- iframe 内容框架 -->
        <iframe id="content-frame" src="/dcdn" frameborder="0" style="width: 100%; height: calc(100vh - 105px); border: none; display: block;"></iframe>
    </div>
    <div class="clear"></div>
    <div class="layui-footer">
        <div class="layui-container">
            <div style="text-align: center; color: #666; width: 100%;">
                <p style="margin: 0;">
                    <!--                    D-NET v1.0.0 - 动态 NET 解析管理系统&nbsp;|&nbsp;-->
                    D-NET {{.Version}} &nbsp;|&nbsp;
                    <a href="https://github.com/cxbdasheng/dnet" target="_blank"
                       style="color: #1e9fff; text-decoration: none;">GitHub</a>
                    &nbsp;|&nbsp;
                    <span>基于 MIT 开源协议</span>
                    &nbsp;|&nbsp;
                    <span>© 2025 D-NET </span>
                </p>
            </div>
        </div>
    </div>
    <div class="ws-shade"></div>
</div>
</body>
<script>
    layui.use(['element', 'layer', 'util', 'form'], function () {
        var element = layui.element;
        var layer = layui.layer;
        var util = layui.util;
        var form = layui.form;
        var $ = layui.$;

        // 导航点击事件 - iframe 切换
        element.on('nav(nav-filter)', function (elem) {
            var navText = $(elem).text().trim();
            var $clickedItem = $(elem);
            var $iframe = $('#content-frame');

            if (navText === 'DCDN'){
                // 切换到 DCDN 页面
                $iframe.attr('src', '/dcdn');
                // 更新导航选中状态
                $('.layui-nav[lay-filter="nav-filter"] .layui-nav-item').removeClass('layui-this');
                $clickedItem.addClass('layui-this');
            }else if (navText === 'DDNS'){
                // // 切换到 DDNS 页面
                // $iframe.attr('src', 'ddns_content.html');
                // // 更新导航选中状态
                // $('.layui-nav[lay-filter="nav-filter"] .layui-nav-item').removeClass('layui-this');
                // $clickedItem.addClass('layui-this');

                // 阻止默认行为，先移除当前元素的选中状态
                $clickedItem.removeClass('layui-this');

                // 弹出提示框
                layer.alert('DDNS 功能正在开发中，敬请期待', {
                    icon: 0,
                    title: '功能提示',
                    closeBtn: 1
                }, function (index) {
                    // 关闭提示框后，保持 DCDN 选中
                    $('.layui-nav[lay-filter="nav-filter"] .layui-nav-item').removeClass('layui-this');
                    $('.layui-nav[lay-filter="nav-filter"] .layui-nav-item').eq(0).addClass('layui-this');
                    layer.close(index);
                });

                // 立即恢复 DCDN 选中状态
                setTimeout(function() {
                    $('.layui-nav[lay-filter="nav-filter"] .layui-nav-item').removeClass('layui-this');
                    $('.layui-nav[lay-filter="nav-filter"] .layui-nav-item').eq(0).addClass('layui-this');
                }, 10);
                return false;
            }
        });

        //头部事件
        util.event('lay-header-event', {
            menuLeft: function (othis) { // 左侧菜单事件
                $('#body').toggleClass('ws-nav-show');
                // 切换图标
                const icon = $(othis).find('i');
                if ($('#body').hasClass('ws-nav-show')) {
                    icon.removeClass('layui-icon-spread-left').addClass('layui-icon-close');
                } else {
                    icon.removeClass('layui-icon-close').addClass('layui-icon-spread-left');
                }
            }
        });

        // 点击遮罩层关闭侧边菜单
        $('.ws-shade').on('click', function () {
            $('#body').removeClass('ws-nav-show');
            // 恢复图标状态
            $('[lay-header-event="menuLeft"] i').removeClass('layui-icon-close').addClass('layui-icon-spread-left');
        });

        // 日志状态
        $('#logs').on('click', function () {
            // 模拟日志数据
            var logData = [
                {time: '2024-01-15 14:30:25', level: 'INFO', message: 'DCDN 服务已启动'},
                {time: '2024-01-15 14:30:30', level: 'INFO', message: '正在获取 IPv4 地址...'},
                {time: '2024-01-15 14:30:32', level: 'SUCCESS', message: 'IPv4 地址获取成功: 192.168.1.100'},
                {time: '2024-01-15 14:30:35', level: 'INFO', message: '正在更新 CDN 记录...'},
                {time: '2024-01-15 14:30:38', level: 'SUCCESS', message: 'CDN 记录更新成功'},
                {time: '2024-01-15 14:31:25', level: 'INFO', message: 'IPv6 地址检测中...'},
                {time: '2024-01-15 14:31:28', level: 'SUCCESS', message: 'IPv6 地址获取成功: 2001:db8::1'},
                {time: '2024-01-15 14:31:30', level: 'INFO', message: 'DNS 记录同步中...'},
                {time: '2024-01-15 14:31:33', level: 'SUCCESS', message: 'DNS 记录同步完成'},
                {time: '2024-01-15 14:32:00', level: 'INFO', message: '配置自动保存'},
                {time: '2024-01-15 14:32:15', level: 'WARNING', message: '检测到网络延迟较高'},
                {time: '2024-01-15 14:32:20', level: 'INFO', message: '正在重试网络连接...'},
                {time: '2024-01-15 14:32:25', level: 'SUCCESS', message: '网络连接已恢复'},
                {time: '2024-01-15 14:33:00', level: 'INFO', message: '定时任务执行中...'},
                {time: '2024-01-15 14:33:05', level: 'INFO', message: 'IP 地址未发生变化'},
                {time: '2024-01-15 14:34:00', level: 'INFO', message: '系统状态检查完成'},
                {time: '2024-01-15 14:34:30', level: 'ERROR', message: 'CDN API 调用失败，正在重试...'},
                {time: '2024-01-15 14:34:35', level: 'SUCCESS', message: 'CDN API 调用重试成功'},
                {time: '2024-01-15 14:35:00', level: 'INFO', message: '配置验证通过'},
                {time: '2024-01-15 14:35:30', level: 'INFO', message: '正在备份配置文件...'},
                {time: '2024-01-15 14:35:32', level: 'SUCCESS', message: '配置文件备份完成'},
                {time: '2024-01-15 14:36:00', level: 'INFO', message: '监控服务运行正常'},
                {time: '2024-01-15 14:36:15', level: 'INFO', message: 'IPv4 权重调整为 15'},
                {time: '2024-01-15 14:36:20', level: 'SUCCESS', message: '权重配置已生效'},
                {time: '2024-01-15 14:37:00', level: 'INFO', message: '定时同步任务开始'},
                {time: '2024-01-15 14:37:05', level: 'INFO', message: '检查域名解析状态...'},
                {time: '2024-01-15 14:37:08', level: 'SUCCESS', message: '域名解析正常'},
                {time: '2024-01-15 14:37:30', level: 'WARNING', message: 'IPv6 连接测试超时'},
                {time: '2024-01-15 14:37:35', level: 'INFO', message: '正在重新测试 IPv6 连接...'},
                {time: '2024-01-15 14:37:40', level: 'SUCCESS', message: 'IPv6 连接测试通过'},
                {time: '2024-01-15 14:38:00', level: 'INFO', message: '系统运行时间: 8分钟'},
                {time: '2024-01-15 14:38:30', level: 'INFO', message: '内存使用率: 45%'},
                {time: '2024-01-15 14:39:00', level: 'INFO', message: '网络带宽使用正常'},
                {time: '2024-01-15 14:39:15', level: 'INFO', message: '配置项同步完成'},
                {time: '2024-01-15 14:39:30', level: 'SUCCESS', message: '所有服务运行正常'},
                {time: '2024-01-15 14:40:00', level: 'INFO', message: 'AccessKey 验证通过'},
                {time: '2024-01-15 14:40:15', level: 'INFO', message: 'CDN 缓存清理中...'},
                {time: '2024-01-15 14:40:18', level: 'SUCCESS', message: 'CDN 缓存清理完成'},
                {time: '2024-01-15 14:40:30', level: 'INFO', message: '负载均衡配置更新'},
                {time: '2024-01-15 14:40:35', level: 'SUCCESS', message: '负载均衡配置生效'},
                {time: '2024-01-15 14:41:00', level: 'INFO', message: '健康检查通过'},
                {time: '2024-01-15 14:41:15', level: 'INFO', message: '静态资源同步中...'},
                {time: '2024-01-15 14:41:20', level: 'SUCCESS', message: '静态资源同步完成'},
                {time: '2024-01-15 14:41:30', level: 'INFO', message: 'SSL 证书状态正常'},
                {time: '2024-01-15 14:42:00', level: 'INFO', message: '安全扫描完成，未发现异常'},
                {time: '2024-01-15 14:42:15', level: 'INFO', message: '日志轮转执行中...'},
                {time: '2024-01-15 14:42:18', level: 'SUCCESS', message: '日志轮转完成'},
                {time: '2024-01-15 14:42:30', level: 'INFO', message: '系统性能监控正常'},
                {time: '2024-01-15 14:43:00', level: 'INFO', message: '定时备份任务完成'},
                {time: '2024-01-15 14:43:15', level: 'SUCCESS', message: '所有任务执行完毕'},
                {time: '2024-01-15 14:43:30', level: 'INFO', message: 'DCDN 服务稳定运行中...'}
            ];

            // 创建日志表格HTML
            var logTableHtml = '<table class="layui-table" lay-size="sm">' +
                '<colgroup>' +
                '<col width="180">' +
                '<col width="100">' +
                '<col>' +
                '</colgroup>' +
                '<thead>' +
                '<tr>' +
                '<th>时间</th>' +
                '<th>级别</th>' +
                '<th>消息</th>' +
                '</tr>' +
                '</thead>' +
                '<tbody>';

            // 添加日志行，并根据级别设置不同颜色
            logData.forEach(function (log) {
                var levelClass = '';
                switch (log.level) {
                    case 'SUCCESS':
                        levelClass = 'color: #5FB878;';
                        break;
                    case 'WARNING':
                        levelClass = 'color: #FFB800;';
                        break;
                    case 'ERROR':
                        levelClass = 'color: #FF5722;';
                        break;
                    default:
                        levelClass = 'color: #666;';
                }

                logTableHtml += '<tr>' +
                    '<td>' + log.time + '</td>' +
                    '<td><span style="' + levelClass + '">' + log.level + '</span></td>' +
                    '<td>' + log.message + '</td>' +
                    '</tr>';
            });

            logTableHtml += '</tbody></table>';

            // 弹出日志查看框
            layer.open({
                type: 1,
                title: '系统日志 (最近50条)',
                area: ['90%', '80%'],
                maxWidth: 900,
                maxHeight: 600,
                content: '<div style="padding: 15px; max-height: calc(80vh - 120px); overflow-y: auto;">' + logTableHtml + '</div>',
                btn: ['清空日志', '关闭'],
                btn1: function (index, layero) {
                    layer.confirm('确定要清空所有日志吗？', {
                        btn: ['确定', '取消']
                    }, function (confirmIndex) {
                        layer.msg('日志已清空', {
                            icon: 1,
                            time: 1500
                        });
                        layer.close(confirmIndex);
                        layer.close(index);
                    });
                },
                btn2: function (index, layero) {
                    layer.close(index);
                }
            });
        });

        // Webhook配置功能 - 加载webhook.html页面
        $('#webhook-config').on('click', function () {
            layer.open({
                type: 2,
                title: 'Webhook 配置',
                area: function () {
                    // 根据屏幕宽度自适应
                    if (window.innerWidth <= 768) {
                        return ['95%', '85%']; // 移动端占用更多屏幕空间
                    } else if (window.innerWidth <= 1024) {
                        return ['80%', '70%']; // 平板端
                    } else {
                        return ['50%', '50%']; // 桌面端
                    }
                }(),
                maxWidth: 900,
                maxHeight: 700,
                shadeClose: true,
                resize: false, // 移动端禁用调整大小
                move: '.layui-layer-title', // 只允许通过标题栏拖拽
                content: '/webhook',
                btn: [
                    '模拟测试 Webhook',
                    '保存配置',
                    '取消'
                ],
                success: function (layero, index) {
                    // 给Webhook弹窗添加特定的CSS类
                    layero.addClass('webhook-dialog');
                },
                btn1: function (index, layero) {
                    // 模拟测试 Webhook 功能
                    var iframe = layero.find('iframe')[0];
                    var iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
                    // 获取表单数据
                    var webhookData = {
                        webhook_enabled: iframeDocument.getElementById('webhook_enable').checked,
                        webhook_url: iframeDocument.getElementById('url').value,
                        webhook_headers: iframeDocument.getElementById('headers').value,
                        webhook_request_body: iframeDocument.getElementById('request_body').value
                    };



                    if (!webhookData.webhook_url) {
                        layer.msg('请先输入 Webhook URL', {
                            icon: 0,
                            time: 2000
                        });
                        return false;
                    }

                    if (!/^https?:\/\//.test(webhookData.webhook_url)) {
                        layer.msg('请输入有效的 HTTP(S) URL', {
                            icon: 2,
                            time: 2000
                        });
                        return false;
                    }

                    // 显示测试中状态
                    layer.msg('正在测试 Webhook 连接...', {
                        icon: 16,
                        shade: 0.3,
                        time: 0
                    });
                    $.ajax({
                        url: '/mock',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(webhookData),
                        success: function (response) {
                            layer.closeAll('msg');
                            try {
                                var res = typeof response === 'string' ? JSON.parse(response) : response;
                                if (res.status) {
                                    layer.msg(res.msg || '保存成功', {
                                        icon: 1,
                                        time: 1500
                                    });
                                    layer.close(index);
                                } else {
                                    layer.msg(res.msg || '保存失败', {
                                        icon: 2,
                                        time: 1500
                                    });
                                }
                            } catch (e) {
                                layer.msg('响应解析失败', {
                                    icon: 2,
                                    time: 2000
                                });
                            }
                        },
                        error: function (xhr, status, error) {
                            layer.closeAll('msg');
                            console.error('请求失败:', {
                                status: xhr.status,
                                statusText: xhr.statusText,
                                error: error,
                                response: xhr.responseText
                            });

                            var errorMsg = '请求失败';
                            if (xhr.responseJSON && xhr.responseJSON.msg) {
                                errorMsg = xhr.responseJSON.msg;
                            } else if (xhr.status === 0) {
                                errorMsg = '无法连接到服务器，请检查网络连接';
                            } else if (xhr.status === 400) {
                                errorMsg = '请求参数错误';
                            } else if (xhr.status === 404) {
                                errorMsg = '请求的资源不存在';
                            } else if (xhr.status === 500) {
                                errorMsg = '服务器内部错误';
                            } else if (error) {
                                errorMsg = error;
                            }

                            layer.msg(errorMsg, {
                                icon: 2,
                                time: 3000
                            });
                        }
                    });
                    return false;
                },
                btn2: function (index, layero) {
                    // 获取iframe中的表单数据并保存
                    var iframe = layero.find('iframe')[0];
                    var iframeDocument = iframe.contentDocument || iframe.contentWindow.document;

                    // 获取表单数据
                    var webhookData = {
                        webhook_enabled: iframeDocument.getElementById('webhook_enable').checked,
                        webhook_url: iframeDocument.getElementById('url').value,
                        webhook_headers: iframeDocument.getElementById('headers').value,
                        webhook_request_body: iframeDocument.getElementById('request_body').value
                    };

                    // 只有启用时才验证数据
                    if (webhookData.webhook_enabled && !webhookData.webhook_url.trim()) {
                        layer.msg('启用 Webhook 时，URL 不能为空', {
                            icon: 2,
                            time: 2000
                        });
                        return false;
                    }
                    // 发送保存请求
                    $.ajax({
                        url: '/webhook',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(webhookData),
                        success: function (response) {
                            try {
                                var res = typeof response === 'string' ? JSON.parse(response) : response;
                                if (res.status) {
                                    layer.msg(res.msg || '保存成功', {
                                        icon: 1,
                                        time: 1500
                                    });
                                    layer.close(index);
                                } else {
                                    layer.msg(res.msg || '保存失败', {
                                        icon: 2,
                                        time: 1500
                                    });
                                }
                            } catch (e) {
                                layer.msg('响应解析失败', {
                                    icon: 2,
                                    time: 2000
                                });
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('请求失败:', {
                                status: xhr.status,
                                statusText: xhr.statusText,
                                error: error,
                                response: xhr.responseText
                            });

                            var errorMsg = '请求失败';
                            if (xhr.responseJSON && xhr.responseJSON.msg) {
                                errorMsg = xhr.responseJSON.msg;
                            } else if (xhr.status === 0) {
                                errorMsg = '无法连接到服务器，请检查网络连接';
                            } else if (xhr.status === 400) {
                                errorMsg = '请求参数错误';
                            } else if (xhr.status === 404) {
                                errorMsg = '请求的资源不存在';
                            } else if (xhr.status === 500) {
                                errorMsg = '服务器内部错误';
                            } else if (error) {
                                errorMsg = error;
                            }

                            layer.msg(errorMsg, {
                                icon: 2,
                                time: 3000
                            });
                        }
                    });
                },
                btn3: function (index, layero) {
                    layer.close(index);
                },
            });
        });

        // 系统设置
        $('#settings').on('click', function () {
            layer.open({
                type: 2,
                title: '系统设置',
                area: function () {
                    // 根据屏幕宽度自适应
                    if (window.innerWidth <= 768) {
                        return ['90%', '60%']; // 移动端
                    } else if (window.innerWidth <= 1024) {
                        return ['60%', '50%']; // 平板端
                    } else {
                        return ['40%', '35%']; // 桌面端
                    }
                }(),
                maxWidth: 800,
                maxHeight: 500,
                shadeClose: true,
                resize: false, // 禁用调整大小
                move: '.layui-layer-title', // 只允许通过标题栏拖拽
                content: '/settings',
                btn: [
                    '保存',
                    '取消'
                ],
                btn1: function (index, layero) {
                    // 获取iframe中的表单数据并保存
                    var iframe = layero.find('iframe')[0];
                    var iframeDocument = iframe.contentDocument || iframe.contentWindow.document;

                    // 获取表单数据
                    var settingsData = {
                        not_allow_wan_access: iframeDocument.getElementById('not_allow_wan_access').checked,
                        username: iframeDocument.getElementById('username').value,
                        password: iframeDocument.getElementById('password').value
                    };

                    // 验证数据
                    if (!settingsData.username.trim()) {
                        layer.msg('用户名不能为空', {
                            icon: 2,
                            time: 2000
                        });
                        return false;
                    }
                    // 发送 ajax 事件
                    $.ajax({
                        url: '/settings',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(settingsData),
                        success: function (response) {
                            try {
                                var res = typeof response === 'string' ? JSON.parse(response) : response;
                                if (res.status) {
                                    layer.msg(res.msg || '保存成功', {
                                        icon: 1,
                                        time: 1500
                                    });
                                    layer.close(index);
                                } else {
                                    layer.msg(res.msg || '保存失败', {
                                        icon: 2,
                                        time: 1500
                                    });
                                }
                            } catch (e) {
                                layer.msg('响应解析失败', {
                                    icon: 2,
                                    time: 2000
                                });
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('请求失败:', {
                                status: xhr.status,
                                statusText: xhr.statusText,
                                error: error,
                                response: xhr.responseText
                            });

                            var errorMsg = '请求失败';
                            if (xhr.responseJSON && xhr.responseJSON.msg) {
                                errorMsg = xhr.responseJSON.msg;
                            } else if (xhr.status === 0) {
                                errorMsg = '无法连接到服务器，请检查网络连接';
                            } else if (xhr.status === 400) {
                                errorMsg = '请求参数错误';
                            } else if (xhr.status === 404) {
                                errorMsg = '请求的资源不存在';
                            } else if (xhr.status === 500) {
                                errorMsg = '服务器内部错误';
                            } else if (error) {
                                errorMsg = error;
                            }

                            layer.msg(errorMsg, {
                                icon: 2,
                                time: 3000
                            });
                        }
                    });
                },
                btn2: function (index, layero) {
                    layer.close(index);
                }
            });
        });
    })
</script>
</html>
