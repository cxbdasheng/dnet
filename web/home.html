<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>D-NET</title>
    <link rel="stylesheet" href="/static/css/layui.css">
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <script src="/static/layui.js"></script>
    <style>
        .layui-layer-right-top.layui-layer-msg {
            top: 60px !important;
            background-color: rgba(0,0,0,.6);
            border: none;
            color: #fff;
            /*box-shadow: 0 2px 4px rgba(0,0,0,.12) !important;*/
        }

        .layui-layer-right-top.layui-layer-msg .layui-layer-content {
            padding: 8px 15px !important;
            word-break: break-all;
        }
        .layui-layer-right-top-error.layui-layer-msg {
            top: 60px !important;
            background-color: rgba(0,0,0,.6);
            border: none;
            color: #9d0808;
            /*box-shadow: 0 2px 4px rgba(0,0,0,.12) !important;*/
        }

        .layui-layer-right-top-error.layui-layer-msg .layui-layer-content {
            padding: 8px 15px !important;
            word-break: break-all;
        }
    </style>
</head>
<body>
<div class="layui-layout layui-layout-admin" id="body">
    <div class="layui-header header">
        <div class="layui-container">
            <div class="layui-logo layui-hide-xs layui-bg-black">
                <a href="/">
                    D-NET
                </a>
            </div>
            <!-- 移动端显示 -->
            <ul class="layui-nav">
                <li class="layui-nav-item layui-show-xs-inline-block layui-hide-sm" lay-header-event="menuLeft">
                    <i class="layui-icon layui-icon-spread-left"></i>
                </li>
            </ul>
            <!-- 头部区域（可配合layui 已有的水平导航） -->
            <div class="ws-header-menu">
                <ul class="layui-nav layui-layout-left" lay-filter="nav-filter">
                    <li class="layui-nav-item layui-hide-xs layui-this"><a href="javascript:;">DCDN</a></li>
                    <li class="layui-nav-item layui-hide-xs"><a href="javascript:;">DDNS</a></li>
                </ul>
            </div>

            <ul class="layui-nav  layui-layout-right">
                <li class="layui-nav-item" lay-unselect>
                    <a href="javascript:;" id="logs">
                        日志<span class="layui-badge-dot"></span>
                    </a>
                </li>
                <li class="layui-nav-item" lay-unselect>
                    <a href="javascript:;">
                        <img src="/static/default.jpg" class="layui-nav-img">
                    </a>
                    <dl class="layui-nav-child">
                        <dd><a href="javascript:;" id="webhook-config">Webhook</a></dd>
                        <dd><a href="javascript:;" id="settings">系统设置</a></dd>
                        <hr>
                        <dd style="text-align: center;"><a href="./logout">退出</a></dd>
                    </dl>
                </li>
            </ul>
        </div>
    </div>
    <div class="layui-body" style="overflow: hidden;">
        <!-- iframe 内容框架 -->
        <iframe id="content-frame" src="/dcdn" frameborder="0"
                style="width: 100%; height: calc(100vh - 105px); border: none; display: block;"></iframe>
    </div>
    <div class="clear"></div>
    <div class="layui-footer">
        <div class="layui-container">
            <div style="text-align: center; color: #666; width: 100%;">
                <p style="margin: 0;">
                    <!--                    D-NET v1.0.0 - 动态 NET 解析管理系统&nbsp;|&nbsp;-->
                    D-NET {{.Version}} &nbsp;|&nbsp;
                    <a href="https://github.com/cxbdasheng/dnet" target="_blank"
                       style="color: #1e9fff; text-decoration: none;">GitHub</a>
                    &nbsp;|&nbsp;
                    <span>基于 MIT 开源协议</span>
                    &nbsp;|&nbsp;
                    <span>© 2025 D-NET </span>
                </p>
            </div>
        </div>
    </div>
    <div class="ws-shade"></div>
</div>
</body>
<script>
    layui.use(['element', 'layer', 'util', 'form'], function () {
        var element = layui.element;
        var layer = layui.layer;
        var util = layui.util;
        var form = layui.form;
        var $ = layui.$;

        // 导航点击事件 - iframe 切换
        element.on('nav(nav-filter)', function (elem) {
            var navText = $(elem).text().trim();
            var $clickedItem = $(elem);
            var $iframe = $('#content-frame');

            if (navText === 'DCDN') {
                // 切换到 DCDN 页面
                $iframe.attr('src', '/dcdn');
                // 更新导航选中状态
                $('.layui-nav[lay-filter="nav-filter"] .layui-nav-item').removeClass('layui-this');
                $clickedItem.addClass('layui-this');
            } else if (navText === 'DDNS') {
                // // 切换到 DDNS 页面
                // $iframe.attr('src', 'ddns_content.html');
                // // 更新导航选中状态
                // $('.layui-nav[lay-filter="nav-filter"] .layui-nav-item').removeClass('layui-this');
                // $clickedItem.addClass('layui-this');

                // 阻止默认行为，先移除当前元素的选中状态
                $clickedItem.removeClass('layui-this');

                // 弹出提示框
                layer.alert('DDNS 功能正在开发中，敬请期待', {
                    icon: 0,
                    title: '功能提示',
                    closeBtn: 1
                }, function (index) {
                    // 关闭提示框后，保持 DCDN 选中
                    $('.layui-nav[lay-filter="nav-filter"] .layui-nav-item').removeClass('layui-this');
                    $('.layui-nav[lay-filter="nav-filter"] .layui-nav-item').eq(0).addClass('layui-this');
                    layer.close(index);
                });

                // 立即恢复 DCDN 选中状态
                setTimeout(function () {
                    $('.layui-nav[lay-filter="nav-filter"] .layui-nav-item').removeClass('layui-this');
                    $('.layui-nav[lay-filter="nav-filter"] .layui-nav-item').eq(0).addClass('layui-this');
                }, 10);
                return false;
            }
        });

        //头部事件
        util.event('lay-header-event', {
            menuLeft: function (othis) { // 左侧菜单事件
                $('#body').toggleClass('ws-nav-show');
                // 切换图标
                const icon = $(othis).find('i');
                if ($('#body').hasClass('ws-nav-show')) {
                    icon.removeClass('layui-icon-spread-left').addClass('layui-icon-close');
                } else {
                    icon.removeClass('layui-icon-close').addClass('layui-icon-spread-left');
                }
            }
        });

        // 点击遮罩层关闭侧边菜单
        $('.ws-shade').on('click', function () {
            $('#body').removeClass('ws-nav-show');
            // 恢复图标状态
            $('[lay-header-event="menuLeft"] i').removeClass('layui-icon-close').addClass('layui-icon-spread-left');
        });

        // 日志轮询相关变量
        var logPollingTimer = null;
        var currentLogLayerIndex = null;
        var lastLogCount = 0;
        var lastLogTimestamp = null; // 记录最后一条日志的时间戳
        var hasCheckedInitialLogs = false;

        // 格式化日志级别显示
        function formatLogLevel(level) {
            var levelMap = {
                'info': '信息',
                'warn': '警告',
                'error': '错误'
            };
            return levelMap[level] || level;
        }

        // 格式化日志类型显示
        function formatLogType(type) {
            var typeMap = {
                'system': '系统',
                'dcdn': 'DCDN',
                'ddns': 'DDNS'
            };
            return typeMap[type] || type;
        }

        // 逐条显示新日志
        function showNewLogs(newLogs) {
            if (newLogs.length === 0) return;

            // 限制一次最多显示5条，避免弹窗过多
            var logsToShow = newLogs.slice(-5);
            var delay = 0;

            logsToShow.forEach(function (log, index) {
                setTimeout(function () {
                    // var levelIcon = 0;
                    // if (log.level === 'info') levelIcon = 6;
                    // else if (log.level === 'warn') levelIcon = 0;
                    // else if (log.level === 'error') levelIcon = 2;

                    var logTitle = '[' + formatLogType(log.type) + '] ' + formatLogLevel(log.level);
                    var logContent = log.message;

                    // 如果消息过长，截断显示
                    if (logContent.length > 100) {
                        logContent = logContent.substring(0, 100) + '...';
                    }
                    var skin = 'layui-layer-right-top';
                    if (log.level === 'error'|| log.level === 'ERROR'){
                        skin = 'layui-layer-right-top-error';
                    }
                    layer.msg(logTitle + ': ' + logContent, {
                        // icon: levelIcon,
                        time: 2000,
                        anim: 'slideDown',
                        offset: 'rt', // 使用标准右上角
                        skin: skin // 添加自定义皮肤类
                    });
                }, delay);
                delay += 800; // 每条日志间隔800毫秒
            });
        }

        // 日志轮询函数
        function pollLogs() {
            fetch('/logs/count', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status && data.data && typeof data.data.count !== 'undefined') {
                        var currentCount = data.data.count;
                        var latestLogs = data.data.latest || [];

                        // 首次检查,只记录数量和时间戳不显示红点
                        if (!hasCheckedInitialLogs) {
                            lastLogCount = currentCount;
                            if (latestLogs.length > 0) {
                                lastLogTimestamp = latestLogs[latestLogs.length - 1].timestamp;
                            }
                            hasCheckedInitialLogs = true;
                            return;
                        }

                        // 检查是否有新日志
                        if (currentCount > lastLogCount) {
                            // 显示红点
                            $('#logs .layui-badge-dot').show();

                            // 找出新增的日志（基于时间戳比对）
                            var newLogs = [];
                            if (lastLogTimestamp) {
                                for (var i = 0; i < latestLogs.length; i++) {
                                    if (latestLogs[i].timestamp > lastLogTimestamp) {
                                        newLogs.push(latestLogs[i]);
                                    }
                                }
                            } else {
                                // 如果没有记录时间戳，则取所有新增的日志
                                var newCount = currentCount - lastLogCount;
                                newLogs = latestLogs.slice(-newCount);
                            }

                            // 逐条显示新日志
                            if (newLogs.length > 0) {
                                showNewLogs(newLogs);
                                // 更新最后一条日志的时间戳
                                lastLogTimestamp = latestLogs[latestLogs.length - 1].timestamp;
                            }

                            // 如果日志弹窗已打开,自动刷新
                            if (currentLogLayerIndex !== null) {
                                var layero = $('#layui-layer' + currentLogLayerIndex);
                                if (layero.length > 0) {
                                    var iframe = layero.find('iframe')[0];
                                    if (iframe) {
                                        iframe.contentWindow.location.reload();
                                    }
                                }
                            }

                            lastLogCount = currentCount;
                        }
                    }
                })
                .catch(error => {
                    console.error('日志轮询失败:', error);
                });
        }

        // 启动日志轮询(每5秒)
        function startLogPolling() {
            // 立即执行一次
            pollLogs();

            // 设置定时器
            if (logPollingTimer) {
                clearInterval(logPollingTimer);
            }
            logPollingTimer = setInterval(pollLogs, 5000);
        }

        // 停止日志轮询
        function stopLogPolling() {
            if (logPollingTimer) {
                clearInterval(logPollingTimer);
                logPollingTimer = null;
            }
        }

        // 页面加载时启动轮询
        startLogPolling();

        // 日志状态
        $('#logs').on('click', function () {
            // 隐藏红点
            $('#logs .layui-badge-dot').hide();

            currentLogLayerIndex = layer.open({
                type: 2,
                title: '系统日志（最近 100 条）',
                area: function () {
                    // 根据屏幕宽度自适应
                    if (window.innerWidth <= 768) {
                        return ['90%', '60%']; // 移动端
                    } else if (window.innerWidth <= 1024) {
                        return ['60%', '50%']; // 平板端
                    } else {
                        return ['80%', '65%']; // 桌面端
                    }
                }(),
                maxWidth: 800,
                maxHeight: 500,
                shadeClose: true,
                resize: false, // 禁用调整大小
                move: '.layui-layer-title', // 只允许通过标题栏拖拽
                content: '/logs',
                btn: [
                    '清空日志',
                    '关闭'
                ],
                btn1: function (index, layero) {
                    // 清空日志功能
                    layer.confirm('确定要清空所有日志吗？此操作不可恢复！', {
                        icon: 3,
                        title: '警告',
                        btn: ['确定', '取消']
                    }, function (confirmIndex) {
                        // 显示加载提示
                        var loadIndex = layer.load(1, {shade: [0.3, '#000']});

                        // 调用清空日志 API
                        fetch('/logs', {
                            method: 'DELETE'
                        })
                            .then(response => response.json())
                            .then(data => {
                                layer.close(loadIndex);
                                if (data.status === true) {
                                    layer.msg(data.msg || '日志已清空', {
                                        icon: 1,
                                        time: 1500
                                    });
                                    // 重置日志计数和时间戳
                                    lastLogCount = 0;
                                    lastLogTimestamp = null;
                                    // 刷新 iframe 内容
                                    var iframe = layero.find('iframe')[0];
                                    if (iframe) {
                                        iframe.contentWindow.location.reload();
                                    }
                                } else {
                                    layer.msg('清空失败: ' + (data.msg || '未知错误'), {icon: 2});
                                }
                                layer.close(confirmIndex);
                            })
                            .catch(error => {
                                layer.close(loadIndex);
                                layer.msg('清空失败: ' + error.message, {icon: 2});
                                layer.close(confirmIndex);
                            });
                    });
                    return false; // 阻止默认的关闭行为
                },
                btn2: function (index, layero) {
                    layer.close(index);
                },
                end: function () {
                    // 弹窗关闭时清除索引
                    currentLogLayerIndex = null;
                }
            });
        });

        // Webhook配置功能 - 加载webhook.html页面
        $('#webhook-config').on('click', function () {
            layer.open({
                type: 2,
                title: 'Webhook 配置',
                area: function () {
                    // 根据屏幕宽度自适应
                    if (window.innerWidth <= 768) {
                        return ['95%', '85%']; // 移动端占用更多屏幕空间
                    } else if (window.innerWidth <= 1024) {
                        return ['80%', '70%']; // 平板端
                    } else {
                        return ['50%', '50%']; // 桌面端
                    }
                }(),
                maxWidth: 900,
                maxHeight: 700,
                shadeClose: true,
                resize: false, // 移动端禁用调整大小
                move: '.layui-layer-title', // 只允许通过标题栏拖拽
                content: '/webhook',
                btn: [
                    '模拟测试 Webhook',
                    '保存配置',
                    '关闭'
                ],
                success: function (layero, index) {
                    // 给Webhook弹窗添加特定的CSS类
                    layero.addClass('webhook-dialog');
                },
                btn1: function (index, layero) {
                    // 模拟测试 Webhook 功能
                    var iframe = layero.find('iframe')[0];
                    var iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
                    // 获取表单数据
                    var webhookData = {
                        webhook_enabled: iframeDocument.getElementById('webhook_enable').checked,
                        webhook_url: iframeDocument.getElementById('url').value,
                        webhook_headers: iframeDocument.getElementById('headers').value,
                        webhook_request_body: iframeDocument.getElementById('request_body').value
                    };
                    if (!webhookData.webhook_url) {
                        layer.msg('请先输入 Webhook URL', {
                            icon: 0,
                            time: 2000
                        });
                        return false;
                    }

                    if (!/^https?:\/\//.test(webhookData.webhook_url)) {
                        layer.msg('请输入有效的 HTTP(S) URL', {
                            icon: 2,
                            time: 2000
                        });
                        return false;
                    }

                    // 显示测试中状态
                    layer.msg('正在测试 Webhook 连接...', {
                        icon: 16,
                        shade: 0.3,
                        time: 0
                    });
                    $.ajax({
                        url: '/mock',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(webhookData),
                        success: function (response) {
                            layer.closeAll('msg');
                            try {
                                var res = typeof response === 'string' ? JSON.parse(response) : response;
                                if (res.status) {
                                    layer.msg(res.msg || '测试成功', {
                                        icon: 1,
                                        time: 2000
                                    });
                                } else {
                                    layer.msg(res.msg || '测试失败', {
                                        icon: 2,
                                        time: 2000
                                    });
                                }
                            } catch (e) {
                                layer.msg('响应解析失败', {
                                    icon: 2,
                                    time: 2000
                                });
                            }
                        },
                        error: function (xhr, status, error) {
                            layer.closeAll('msg');
                            console.error('请求失败:', {
                                status: xhr.status,
                                statusText: xhr.statusText,
                                error: error,
                                response: xhr.responseText
                            });

                            var errorMsg = '请求失败';
                            if (xhr.responseJSON && xhr.responseJSON.msg) {
                                errorMsg = xhr.responseJSON.msg;
                            } else if (xhr.status === 0) {
                                errorMsg = '无法连接到服务器，请检查网络连接';
                            } else if (xhr.status === 400) {
                                errorMsg = '请求参数错误';
                            } else if (xhr.status === 404) {
                                errorMsg = '请求的资源不存在';
                            } else if (xhr.status === 500) {
                                errorMsg = '服务器内部错误';
                            } else if (error) {
                                errorMsg = error;
                            }

                            layer.msg(errorMsg, {
                                icon: 2,
                                time: 3000
                            });
                        }
                    });
                    return false;
                },
                btn2: function (index, layero) {
                    // 获取iframe中的表单数据并保存
                    var iframe = layero.find('iframe')[0];
                    var iframeDocument = iframe.contentDocument || iframe.contentWindow.document;

                    // 获取表单数据
                    var webhookData = {
                        webhook_enabled: iframeDocument.getElementById('webhook_enable').checked,
                        webhook_url: iframeDocument.getElementById('url').value,
                        webhook_headers: iframeDocument.getElementById('headers').value,
                        webhook_request_body: iframeDocument.getElementById('request_body').value
                    };

                    // 只有启用时才验证数据
                    if (webhookData.webhook_enabled && !webhookData.webhook_url.trim()) {
                        layer.msg('启用 Webhook 时，URL 不能为空', {
                            icon: 2,
                            time: 2000
                        });
                        return false;
                    }
                    // 发送保存请求
                    $.ajax({
                        url: '/webhook',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(webhookData),
                        success: function (response) {
                            try {
                                var res = typeof response === 'string' ? JSON.parse(response) : response;
                                if (res.status) {
                                    layer.msg(res.msg || '保存成功', {
                                        icon: 1,
                                        time: 1500
                                    });
                                    layer.close(index);
                                } else {
                                    layer.msg(res.msg || '保存失败', {
                                        icon: 2,
                                        time: 1500
                                    });
                                }
                            } catch (e) {
                                layer.msg('响应解析失败', {
                                    icon: 2,
                                    time: 2000
                                });
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('请求失败:', {
                                status: xhr.status,
                                statusText: xhr.statusText,
                                error: error,
                                response: xhr.responseText
                            });

                            var errorMsg = '请求失败';
                            if (xhr.responseJSON && xhr.responseJSON.msg) {
                                errorMsg = xhr.responseJSON.msg;
                            } else if (xhr.status === 0) {
                                errorMsg = '无法连接到服务器，请检查网络连接';
                            } else if (xhr.status === 400) {
                                errorMsg = '请求参数错误';
                            } else if (xhr.status === 404) {
                                errorMsg = '请求的资源不存在';
                            } else if (xhr.status === 500) {
                                errorMsg = '服务器内部错误';
                            } else if (error) {
                                errorMsg = error;
                            }

                            layer.msg(errorMsg, {
                                icon: 2,
                                time: 3000
                            });
                        }
                    });
                },
                btn3: function (index, layero) {
                    layer.close(index);
                },
            });
        });

        // 系统设置
        $('#settings').on('click', function () {
            layer.open({
                type: 2,
                title: '系统设置',
                area: function () {
                    // 根据屏幕宽度自适应
                    if (window.innerWidth <= 768) {
                        return ['90%', '60%']; // 移动端
                    } else if (window.innerWidth <= 1024) {
                        return ['60%', '50%']; // 平板端
                    } else {
                        return ['40%', '35%']; // 桌面端
                    }
                }(),
                maxWidth: 800,
                maxHeight: 500,
                shadeClose: true,
                resize: false, // 禁用调整大小
                move: '.layui-layer-title', // 只允许通过标题栏拖拽
                content: '/settings',
                btn: [
                    '保存',
                    '关闭'
                ],
                btn1: function (index, layero) {
                    // 获取iframe中的表单数据并保存
                    var iframe = layero.find('iframe')[0];
                    var iframeDocument = iframe.contentDocument || iframe.contentWindow.document;

                    // 获取表单数据
                    var settingsData = {
                        not_allow_wan_access: iframeDocument.getElementById('not_allow_wan_access').checked,
                        username: iframeDocument.getElementById('username').value,
                        password: iframeDocument.getElementById('password').value
                    };

                    // 验证数据
                    if (!settingsData.username.trim()) {
                        layer.msg('用户名不能为空', {
                            icon: 2,
                            time: 2000
                        });
                        return false;
                    }
                    // 发送 ajax 事件
                    $.ajax({
                        url: '/settings',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(settingsData),
                        success: function (response) {
                            try {
                                var res = typeof response === 'string' ? JSON.parse(response) : response;
                                if (res.status) {
                                    layer.msg(res.msg || '保存成功', {
                                        icon: 1,
                                        time: 1500
                                    });
                                    layer.close(index);
                                } else {
                                    layer.msg(res.msg || '保存失败', {
                                        icon: 2,
                                        time: 1500
                                    });
                                }
                            } catch (e) {
                                layer.msg('响应解析失败', {
                                    icon: 2,
                                    time: 2000
                                });
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('请求失败:', {
                                status: xhr.status,
                                statusText: xhr.statusText,
                                error: error,
                                response: xhr.responseText
                            });

                            var errorMsg = '请求失败';
                            if (xhr.responseJSON && xhr.responseJSON.msg) {
                                errorMsg = xhr.responseJSON.msg;
                            } else if (xhr.status === 0) {
                                errorMsg = '无法连接到服务器，请检查网络连接';
                            } else if (xhr.status === 400) {
                                errorMsg = '请求参数错误';
                            } else if (xhr.status === 404) {
                                errorMsg = '请求的资源不存在';
                            } else if (xhr.status === 500) {
                                errorMsg = '服务器内部错误';
                            } else if (error) {
                                errorMsg = error;
                            }

                            layer.msg(errorMsg, {
                                icon: 2,
                                time: 3000
                            });
                        }
                    });
                },
                btn2: function (index, layero) {
                    layer.close(index);
                }
            });
        });
    })
</script>
</html>
